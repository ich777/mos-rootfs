#!/bin/sh

# Set remove layers if empty
REMOVE_LAYERS=${REMOVE_LAYERS:-true}

# Get Docker appdata directory
DOCKER_APPDATA=$(jq -r '.appdata' /boot/config/docker.json)
CONTAINER_UPDATES=()

# Check if argument was passed over (update single or all containers)
if [ -z "$1" ] ; then
  CONTAINERS_JSON=$(cat /var/lib/docker/mos/containers)
  CONTAINER_NAMES=$(echo $CONTAINERS_JSON | jq -r '.[].name')
  COMPOSE_JSON=$(cat /var/lib/docker/mos/compose-containers)
  COMPOSE_STACKS=$(echo $COMPOSE_JSON | jq -r '.[].stack')
elif [ "$3" = "compose" ] ; then
  COMPOSE_JSON=$(cat /var/lib/docker/mos/compose-containers)
  COMPOSE_STACKS=$(echo $COMPOSE_JSON | jq -r --arg name "$1" '.[] | select(.stack == $name) | .stack')
else
  CONTAINERS_JSON=$(cat /var/lib/docker/mos/containers)
  if echo $CONTAINERS_JSON | jq -e --arg name "$1" '.[] | select(.name == $name)' >/dev/null ; then
    CONTAINER_NAMES=$1
  else
    echo "Container $1 not in container list found"
    exit 1
  fi
fi

# Import MOS functions
. /usr/local/lib/functions/mos-common

# Get tokens if set
GH_TOKEN=$(jq -r '.github // empty' /boot/config/system/tokens.json)
DOCKER_TOKEN=$(jq -r '.dockerhub // empty' /boot/config/system/tokens.json)

# Create DOCKER_CONFIG if Tokens are set
if [[ -z "$GH_TOKEN" && -z "$DOCKER_TOKEN" ]] ; then
  unset DOCKER_CONFIG
else
  CONFIG_JSON='{"auths":{}}'
  if [ ! -z "$GH_TOKEN" ] ; then
    GHTOKEN="$(decrypt_password "$GH_TOKEN" "tokens")"
    GHAUTH=$(echo -n "_:$GHTOKEN" | base64 -w0)
    CONFIG_JSON=$(echo "$CONFIG_JSON" | jq --arg auth "$GHAUTH" \
      '.auths["ghcr.io"] = {auth: $auth}')
  fi
  if [ ! -z "$DOCKER_TOKEN" ] ; then
    DOCKERTOKEN="$(decrypt_password "$DOCKER_TOKEN" "tokens")"
    DOCKERAUTH=$(echo -n "$DOCKERTOKEN" | base64 -w0)
    CONFIG_JSON=$(echo "$CONFIG_JSON" | jq --arg auth "$DOCKERAUTH" \
      '.auths["https://index.docker.io/v1/"] = {auth: $auth}')
  fi
  if [ ! -d /var/mos/docker-auth ] ; then
    mkdir -p /var/mos/docker-auth
  fi
  echo "$CONFIG_JSON" > "/var/mos/docker-auth/config.json"
  export DOCKER_CONFIG="/var/mos/docker-auth"
fi

# Loop through containers
for container in $CONTAINER_NAMES
do
  LOCAL_SHA=$(echo $CONTAINERS_JSON | jq -r --arg name "$container" '.[] | select(.name == $name) | .local')
  # When force_update is passed over set remote SHA to force_update to always trigger an update
  if [ "$2" = "force_update" ] ; then
    REMOTE_SHA="force_update"
  else
    REMOTE_SHA=$(echo $CONTAINERS_JSON | jq -r --arg name "$container" '.[] | select(.name == $name) | .remote')
  fi
  # Compare local and remote SHA with error handling if no container JSON is found
  if [ "$LOCAL_SHA" != "$REMOTE_SHA" ] ; then
    if [ ! -f /boot/config/system/docker/templates/$container.json ] ; then
      echo "ERROR: $container.json not found"
      continue
    fi
    cd /boot/config/system/docker/templates
    mos-deploy_docker "$container.json" "update_container"
    CONTAINER_UPDATES+=("$container")
  fi
done

# Loop through compose stacks
for stack in $COMPOSE_STACKS
do
  STACK_JSON=$(echo $COMPOSE_JSON | jq -r --arg name "$stack" '.[] | select(.stack == $name)')
  STACK_UPDATE=false
  if [ "$2" = "force_update" ] ; then
    STACK_UPDATE=true
  elif echo "$STACK_JSON" | jq -e 'any(.services[]; .local != .remote)' > /dev/null; then
    STACK_UPDATE=true
  fi
  if [ "$STACK_UPDATE" = "true" ] ; then
    echo "Updating compose stack $stack"
    if [ -d "$DOCKER_APPDATA/compose_$stack" ] ; then
      cd $DOCKER_APPDATA/compose_$stack
      if [ -f "$DOCKER_APPDATA/compose_$stack/mos.override.yaml" ] ; then
        COMPOSE_ARGS="-f compose.yaml -f mos.override.yaml"
      else
        COMPOSE_ARGS="-f compose.yaml"
      fi
      docker-compose down
      docker-compose pull
      docker-compose $COMPOSE_ARGS up -d --remove-orphans
      CONTAINER_UPDATES+=("$stack")
    else
      echo "ERROR: Stack directory $DOCKER_APPDATA/compose_$stack not found"
    fi
  fi
done

# Remove DOCKER_CONFIG and config.json
if [ -f /var/mos/docker-auth/config.json ] ; then
  rm -f /var/mos/docker-auth/config.json
fi
unset DOCKER_CONFIG

# Send notify if all container where updated
if [ "$2" = "notification" ] ; then
  if [ -z "$1" ] ; then
    if [ ! -z "$CONTAINER_UPDATES" ] ; then
      MSG_UPDATES=$(IFS=','; echo "${CONTAINER_UPDATES[*]}")
      MSG_UPDATES=${MSG_UPDATES//,/,\ }
      notify -t "Docker Updates" -m "Docker Containers updated: $MSG_UPDATES" -p "normal"
    else
      notify -t "Docker Updates" -m "Nothing to do, all containers up to date" -p "normal"
    fi
  fi
else
  if [ -z "$1" ] ; then
    if [ ! -z "$CONTAINER_UPDATES" ] ; then
      MSG_UPDATES=$(IFS=','; echo "${CONTAINER_UPDATES[*]}")
      MSG_UPDATES=${MSG_UPDATES//,/,\ }
      echo
      echo "Containers updated: $MSG_UPDATES"
    else
      echo "Nothing to do, all containers up to date"
    fi
  else
    if [ ! -z "$CONTAINER_UPDATES" ] ; then
      echo
      echo "Container $1 updated"
    else
      echo "Container $1 up to date"
    fi
  fi
fi

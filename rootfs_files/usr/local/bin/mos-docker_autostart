#!/bin/sh
# Wait for Docker daemon to start to continue or abort after 30 seconds
counter=0
while ! docker info >/dev/null 2>&1 ; do
  if [ $counter -ge 30 ]; then
    logger -t "mos-docker_autostart" "Error: Docker daemon not ready, aborting Container autostart"
    exit 1
  fi
  sleep 1
  ((counter++))
done

sleep 2

# Get Autostart and Wait time from containers where autostart is enabled and
# Docker wait time before Docker autostart is executed
AUTOSTART_CONTAINERS=$(jq -r '.[] | select(.autostart == true) | "\(.index):\(.name):\(.wait)"' /var/lib/docker/mos/containers 2>/dev/null | sort -n -t: -k1,1)
DOCKER_WAIT=$(jq -r '.start_wait' /boot/config/docker.json)
if [ ! -z "$DOCKER_WAIT" ] && [ "$DOCKER_WAIT" != "null" ] && [ "$DOCKER_WAIT" != "0" ]; then
  sleep ${DOCKER_WAIT}s
fi

# Start containers and apply wait time if defined before container is started
if [ ! -z "$AUTOSTART_CONTAINERS" ] && [ "$AUTOSTART_CONTAINERS" != "null" ] ; then
  for container in $AUTOSTART_CONTAINERS
  do
    CONTAINER=${container#*:}
    if [ ! -z "${CONTAINER#*:}" ] && [ "${CONTAINER#*:}" != "0" ] && [ "${CONTAINER#*:}" != "null" ] ; then
      sleep ${CONTAINER#*:}s
    fi
    docker container start ${CONTAINER%%:*} >/dev/null 2>&1
  done
fi

COMPOSE_STACKS=$(jq -r '.[] | select(.compose == true) | "\(.index):\(.name)"' /var/lib/docker/mos/groups 2>/dev/null | sort -n -t: -k1,1)
if [ ! -z "$COMPOSE_STACKS" ] && [ "$COMPOSE_STACKS" != "null" ] ; then
  DOCKER_APPDATA=$(jq -r '.appdata' /boot/config/docker.json)
  for stack in $COMPOSE_STACKS
  do
    STACK=${stack#*:}
    AUTOSTART_STACK=false
    AUTOSTART_STACK=$(jq -r --arg name "$STACK" '.[] | select(.stack == $name) | .autostart' /var/lib/docker/mos/compose-containers)
    if [ "$AUTOSTART_STACK" = "true" ] ; then
      if [ -d "$DOCKER_APPDATA/compose_$STACK" ] ; then
        cd $DOCKER_APPDATA/compose_$STACK
        if [ -f "$DOCKER_APPDATA/compose_$stack/mos.override.yaml" ] ; then
          COMPOSE_ARGS="-f compose.yaml -f mos.override.yaml"
        else
          COMPOSE_ARGS="-f compose.yaml"
        fi
        docker-compose $COMPOSE_ARGS up -d
      fi
    fi
  done
fi

# Start Docker container network watchdog
/etc/init.d/docker-watchdog start

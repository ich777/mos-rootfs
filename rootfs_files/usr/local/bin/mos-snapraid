#!/bin/bash
# Check if SnapRAID configuration is available
if [ -z "$1" ] ; then
  exit 1
elif [ ! -f /boot/config/snapraid/$1.conf ] ; then
  echo "ERROR: SnapRAID configuration $1.config not found"
  exit 1
fi
if [ -z "$2" ] ; then
  exit 1
fi

# Check if SnapRAID operation is already running
if [ "$2" != "force_stop" ] && [ -f /run/snapraid/$1.socket ] ; then
  echo "ERROR: Operation for Pool: $2 already running"
  exit 1
fi

# Security checks for second argument
if [ "$2" = "force_stop" ] ; then
  if [ -f /run/snapraid/$1.socket ] ; then
    echo "Trying to stop currently running SnapRAID operation on Pool: $1"
    kill -9 $(pgrep -f "snapraid -c /boot/config/snapraid/$1.conf") 2>/dev/null
    kill -9 $(pgrep -f "mos-snapraid $1" | grep -v $$) 2>/dev/null
    rm -f /run/snapraid/$1.socket
    notify -t "SnapRAID" -m "SnapRAID operation for Pool $1 forcfully stopped" -p "warning"
    echo "SnapRAID operation for Pool: $1 forcefully stopped"
    exit 0
  else
    echo "No SnapRAID operation for Pool: $1 running"
    exit 0
  fi
elif [ "$2" = "fix" ] ; then
  if [ -z "$3" ] ; then
    echo "ERROR: Please specify the data disk that you want to rebuild"
    exit 1
  else
    FIX_DISKS=$(printf ' -d %s' ${3//,/ })
  fi
else
  FIX_DISKS=""
fi

# Get Pool information
POOL_INFO=$(jq --arg pool_name "$1" '.[] | select(.name == $pool_name)' /boot/config/pools.json)
if [ -z "$POOL_INFO" ] ; then
  echo "ERROR: Pool $1 not found in pools.json"
  exit 1
fi

# Check if pool is actually mounted
if ! findmnt /mnt/$1 >/dev/null 2>&1 ; then
  echo "Pool $1 not mounted, skipping"
  exit 1
fi

# Get Disks
DISKS=$(echo $POOL_INFO | jq -r '.data_devices[].id')
PARITY=$(echo $POOL_INFO | jq -r '.parity_devices[].id')

# Get power status from disks
disk_array=()
for disk in $DISKS
do
  hdparm -C /dev/disk/by-uuid/$disk | grep -qi "standby"
  STANDBY=$?
  disk_array+=("$disk:$STANDBY")
done

# Create Directories
[ ! -d /var/log/snapraid ] && \
  mkdir -p /var/log/snapraid

[ ! -d /run/snapraid ] && \
  mkdir -p /run/snapraid

# Start SnapRAID operation in background
{
  # Send notification and start SnapRAID operation
  notify -t "SnapRAID" -m "Starting SnapRAID operation $2 for Pool: $1" -p "normal"
  snapraid -c /boot/config/snapraid/$1.conf$FIX_DISKS -l /var/log/snapraid/$1 $2 > /run/snapraid/$1.socket 2>&1

  # Sync filesystems and wait for additional 3 minutes
  sync
  sleep 180

  # Put disks into power stat that they where before running the check
  for disk_info in "${disk_array[@]}"; do
    if [ "${disk_info##*:}" = "0" ] ; then
      hdparm -y $(realpath /dev/disk/by-uuid/${disk_info%%:*})
    fi
  done

  # Put parity devices into sleep
  for parity in $PARITY
  do
    hdparm -y $(realpath /dev/disk/by-uuid/$parity)
  done

  # Send end notification and remove socket
  notify -t "SnapRAID" -m "SnapRAID operation $2 for Pool: $1 completed" -p "normal"

  rm -f /run/snapraid/$1.socket
} >/dev/null 2>&1 &

echo "SnapRAID $2 for pool $1 started in background"

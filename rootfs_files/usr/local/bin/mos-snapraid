#!/bin/sh
if [ -z "$1" ] ; then
  exit 1
elif [ ! -f /boot/config/snapraid/$1.conf ] ; then
  echo "ERROR: SnapRAID configuration $1.config not found"
  exit 1
fi
if [ -z "$2" ] ; then
  exit 1
fi

if [ "$2" != "force_stop" ] && [ -f /run/snapraid/$1.socket ] ; then
  echo "ERROR: Operation for Pool: $2 already running"
  exit 1
fi

if [ "$2" = "force_stop" ] ; then
  if [ -f /run/snapraid/$1.socket ] ; then
    echo "Trying to stop currently running SnapRAID operation on Pool: $1"
    kill -9 $(pgrep -f "snapraid -c /boot/config/snapraid/$1.conf") 2>/dev/null
    kill -9 $(pgrep -f "mos-snapraid $1" | grep -v $$) 2>/dev/null
    rm -f /run/snapraid/$1.socket
    echo "SnapRAID operation forcefully stopped"
    exit 0
  else
    echo "No SnapRAID operation for Pool: $1 running"
    exit 0
  fi
fi

POOL_INFO=$(jq --arg pool_name "$1" '.[] | select(.name == $pool_name)' /boot/config/pools.json)
if [ -z "$POOL_INFO" ] ; then
  echo "ERROR: Pool $1 not found in pools.json"
  exit 1
fi

DISKS=$(echo $POOL_INFO | jq -r '.data_devices[].id')
PARITY=$(echo $POOL_INFO | jq -r '.parity_devices[].id')

disk_array=()
for disk in $DISKS
do
  hdparm -C /dev/disk/by-uuid/$disk | grep -qi "standby"
  STANDBY=$?
  disk_array+=("$disk:$STANDBY")
done

[ ! -d /var/log/snapraid ] && \
  mkdir -p /var/log/snapraid

[ ! -d /run/snapraid ] && \
  mkdir -p /run/snapraid

{
  snapraid -c /boot/config/snapraid/$1.conf -l /var/log/snapraid/$1 $2 > /run/snapraid/$1.socket 2>&1

  sync
  sleep 180

  for disk_info in "${disk_array[@]}"; do
    if [ "${disk_info##*:}" = "0" ] ; then
      hdparm -y $(realpath /dev/disk/by-uuid/${disk_info%%:*})
    fi
  done

  for parity in $PARITY
  do
    hdparm -y $(realpath /dev/disk/by-uuid/$parity)
  done

  rm -f /run/snapraid/$1.socket
} >/dev/null 2>&1 &

echo "SnapRAID $2 for pool $1 started in background"

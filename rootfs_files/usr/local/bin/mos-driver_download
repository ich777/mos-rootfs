#!/bin/bash

# Check if argument is passed over and set mode acordingly
if [ -z "$1" ] ; then
  echo "You have to at least specify the driver name"
  exit 1
elif [ "$1" = "upgrade" ] ; then
  MODE="upgrade"
elif [ "$1" = "update" ] ; then
  MODE="update"
  if [ "$2" = "$(uname -r)" ] ; then
    echo "Nothing to do for Drivers"
    exit 0
  fi
else
  MODE="$1"
fi

# Set Kernel
if [ -z "$2" ] ; then
  UNAME="$(uname -r)"
else
  UNAME="$2"
  if [ "$MODE" = "upgrade" ] ; then
    UNAME="$(uname -r)"
  fi
fi

# GH Token
TOKEN="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"

# Set Title
if [ "$1" = "update" ] ; then
  NOTIFY_TITLE="MOS Update"
else
  NOTIFY_TITLE="MOS Drivers"
fi

# Call mos-os_get_releases to get available MOS versions
if ! /usr/local/bin/mos-drivers_get_releases "$UNAME" ; then
  exit 1
fi

# Create necessary directories
mkdir -p /var/mos/mos-drivers/download/$UNAME >/dev/null 2>&1

# Load drivers into variable
DRIVERS_JSON="$(cat /var/mos/mos-drivers/drivers-$UNAME.json)"

# Get available driver packages
AVAILABLE_DRIVERS="$(echo $DRIVERS_JSON | jq -r '.assets[].name | select(endswith(".deb.md5") | not)')"

# Chick if this is an update/upgrade and set mode
if [ "$MODE" = "update" ] || [ "$MODE" = "upgrade" ] ; then
  # Get installed drivers
  INSTALLED_DRIVERS="$(ls -1 /boot/optional/drivers/ 2>/dev/null)"

  if [ -z "$INSTALLED_DRIVERS" ] ; then
    echo "No installed addon drivers found"
    exit 0
  fi
fi

# Download function with md5 check
download_asset() {
  echo "Downloading: ${3}"
  if [ -z "$4" ] ; then
    notify -t "$NOTIFY_TITLE" -m "Downloading driver: ${3}" -p "normal"
  fi
  curl --progress-bar -L \
    --header "Authorization: Bearer $TOKEN" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/boot/optional/drivers/$1/$UNAME/${3}${4}" \
    "https://api.github.com/repos/ich777/mos-addon-drivers/releases/assets/$2"

  if [ "$4" = ".md5" ] ; then
    if [ "$(md5sum /boot/optional/drivers/$1/$UNAME/$3 | awk '{print $1}')" != "$(cat /boot/optional/drivers/$1/$UNAME/${3}${4} | awk '{print $1}')" ] ; then
      echo "$3 checksom ERROR"
      notify -t "$NOTIFY_TITLE" -m "Checksum error for driver: ${3}" -p "warning"
      return 1
    else
      echo "$3 checksum OK"
      notify -t "$NOTIFY_TITLE" -m "Driver download: ${3} successful" -p "normal"
    fi
  fi
}

# Install/update/upgrade drivers depending on set mode
if [ "$MODE" = "upgrade" ] ; then
  REBOOT=false
  PACKAGES=""
  for driver_dir in $INSTALLED_DRIVERS
  do
    PACKAGES="$PACKAGES
$(ls -1 /boot/optional/drivers/$driver_dir/*/*.deb 2>/dev/null | sort -V | tail -1 | cut -d '/' -f7)"
  done
  PACKAGES="$(echo "$PACKAGES" | sed '/^$/d')"
  for package in $PACKAGES
  do
    WO_EXT=${package%.deb}
    WO_ARCH=${WO_EXT##*_}
    BASENAME=${WO_EXT%_*}
    NAME=${BASENAME%%_*}
    VERSION_DIST=${BASENAME#*_}
    VERSION=${VERSION_DIST%%+*}
    mkdir -p /boot/optional/drivers/$NAME/$UNAME 2>/dev/null
    DRV="$(echo "$AVAILABLE_DRIVERS" | grep "^${NAME}_" | sort -V | tail -1)"
    if [ -z "$DRV" ] ; then
      echo "Something went wrong for driver: $package"
      continue
    fi
    AVAIL_DRV_V=$(echo $DRV | cut -d '_' -f2- | cut -d '+' -f1)
    if [ "$AVAIL_DRV_V" != "$VERSION" ] ; then
      DRV_ASSET=$(echo "$DRIVERS_JSON" | jq --arg driver $DRV -r '.assets[] | select(.name == $driver) | .id')
      DRV_ASSET_MD5=$(echo "$DRIVERS_JSON" | jq --arg driver $DRV.md5 -r '.assets[] | select(.name == $driver) | .id')
      download_asset "$NAME" "$DRV_ASSET" "$DRV"
      download_asset "$NAME" "$DRV_ASSET_MD5" "$DRV" ".md5"
      EXIT_STATUS=$?
      if [ "$EXIT_STATUS" != "0" ] ; then
        rm -rf /boot/optional/drivers/$NAME/$UNAME
        DRV_FAILED="$NAME
"
        continue
      fi
      echo "Download from driver: $package successful"
      REBOOT=true
    else
      echo "Nothing to do for driver: $package"
    fi
  done
  if [ "$REBOOT" = "true" ] ; then
    echo "Please reboot to complete the driver update"
  fi
elif [ "$MODE" = "update" ] ; then
  REBOOT=false
  PACKAGES=""
  for driver_dir in $INSTALLED_DRIVERS
  do
    PACKAGES="$PACKAGES
$(ls -1 /boot/optional/drivers/$driver_dir/$(uname -r)/*.deb 2>/dev/null | cut -d '/' -f7)"
  done
  PACKAGES="$(echo "$PACKAGES" | sed '/^$/d')"
  for driver in $PACKAGES
  do
    # Disasemble package name to get necessary variables
    WO_EXT=${driver%.deb}
    WO_ARCH=${WO_EXT##*_}
    BASENAME=${WO_EXT%_*}
    NAME=${BASENAME%%_*}
    VERSION_DIST=${BASENAME#*_}
    VERSION=${VERSION_DIST%%+*}
    mkdir -p /boot/optional/drivers/$NAME/$UNAME 2>/dev/null
    if echo "$AVAILABLE_DRIVERS" | grep -q "^${NAME}_${VERSION}" ; then
      DRV="$(echo "$AVAILABLE_DRIVERS" | grep "^${NAME}_${VERSION}")"
    else
      DRV="$(echo "$AVAILABLE_DRIVERS" | grep "^${NAME}_" | sort -V | tail -1)"
    fi
    if [ -z "$DRV" ] ; then
      echo "Something went wrong for driver: $driver"
      continue
    fi
    DRV_ASSET=$(echo "$DRIVERS_JSON" | jq --arg driver $DRV -r '.assets[] | select(.name == $driver) | .id')
    DRV_ASSET_MD5=$(echo "$DRIVERS_JSON" | jq --arg driver $DRV.md5 -r '.assets[] | select(.name == $driver) | .id')
    download_asset "$NAME" "$DRV_ASSET" "$DRV"
    download_asset "$NAME" "$DRV_ASSET_MD5" "$DRV" ".md5"
    EXIT_STATUS=$?
    if [ "$EXIT_STATUS" != "0" ] ; then
      rm -rf /boot/optional/drivers/$NAME/$UNAME
      continue
    fi
    echo "Download from driver: $driver successful"
    DRV_SUCCESS="$NAME
"
  done
else
  WO_EXT=${1%.deb}
  BASENAME=${WO_EXT%_*}
  NAME=${BASENAME%%_*}
  mkdir -p /boot/optional/drivers/$NAME/$UNAME 2>/dev/null
  DRV="$(echo "$AVAILABLE_DRIVERS" | grep "^${NAME}")"
  if [ -z "$DRV" ] ; then
    echo "Something went wrong for driver: $1"
    exit 1
  fi
  DRV_ASSET=$(echo "$DRIVERS_JSON" | jq --arg driver $DRV -r '.assets[] | select(.name == $driver) | .id')
  DRV_ASSET_MD5=$(echo "$DRIVERS_JSON" | jq --arg driver $DRV.md5 -r '.assets[] | select(.name == $driver) | .id')
  download_asset "$NAME" "$DRV_ASSET" "$1"
  download_asset "$NAME" "$DRV_ASSET_MD5" "$1" ".md5"
  EXIT_STATUS=$?
  if [ "$EXIT_STATUS" != "0" ] ; then
    rm -rf /boot/optional/drivers/$NAME/$UNAME
    continue
  fi
  echo "Download from driver: $1 successful, please reboot"
fi

# Cleanup old drivers, or skip if no_driver_cleanup was passed over
if [ "$3" != "no_driver_cleanup" ] ; then
  for driver_dir in $DRV_SUCCESS
  do
    for old in $(ls -1 /boot/optional/drivers/$driver_dir | grep -v "$UNAME")
    do
      rm -rf "/boot/optional/drivers/$driver_dir/$old"
    done
  done
  find /boot/optional/drivers/ -type d -empty -delete 2>/dev/null
fi
exit 0

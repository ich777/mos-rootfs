#!/bin/sh

# Import MOS functions
. /usr/local/lib/functions/mos-common

# Get current version
CURRENT_VERSION=$(jq -r '"\(.mos.version)-\(.mos.channel)"' /etc/mos-release.json 2>/dev/null)

# Set HEADER if GitHub Token was specified
GH_TOKEN=$(jq -r '.github // empty' /boot/config/system/tokens.json)
if [ ! -z "$GH_TOKEN" ] ; then
  TOKEN="$(decrypt_password "$GH_TOKEN" "tokens")"
  HEADER=(--header "Authorization: Bearer $TOKEN")
else
  HEADER=()
fi

# Rollback to previous version
rollback_mos() {
  # Get rollback version
  ROLLBACK_VERSION=$(jq -r '"\(.mos.version)-\(.mos.channel)"' /boot/rollback/mos-release.json 2>/dev/null)

  # Check if rollback version is in place
  if [ -f /boot/rollback/rootfs ] ; then
    notify -t "MOS Update" -m "Rolling back to MOS version: $ROLLBACK_VERSION" -p "normal"
    mv /boot/rollback/rootfs* /boot/
  else
    notify -t "MOS Update" -m "No MOS release to roll back to found" -p "warning"
    exit 1
  fi
  
  # Check if argument was passed over to not roll back Kernel
  if [ "$2" != "not_kernel" ] ; then
    if [ -f /boot/rollback/image ] ; then
      echo "Rolling back Kernel image"
      mv /boot/rollback/image* /boot/
    fi
    if [ -f /boot/rollback/drivers ] ; then
      echo "Rolling back Kernel drivers"
      mv /boot/rollback/drivers* /boot/
    fi
    if [ -f /boot/rollback/microcode ] ; then
      echo "Rolling back microcode"
      mv /boot/rollback/microcode* /boot/
    fi
  fi

  rm -rf /boot/rollback
  notify -t "MOS Update" -m "Rollback done, please reboot" -p "normal"
  exit 0
}

# Check if passed over argument is either "latest" or starting
# with a semantic version or if "rollback_mos" is passed over
case "$1" in
  latest)
  ;;
  [0-9]*.[0-9]*.[0-9]*)
  ;;
  rollback)
    rollback_mos
  ;;
  *)
    echo "Please specify either a valid version latest or rollback"
    exit 1
  ;;
esac

# Check if cahnnel is passed over correctly
case "$2" in
  alpha|beta|stable)
  ;;
  *)
    echo "Channel can only be: alpha, beta or latest"
    exit 1
  ;;
esac

# Call mos-os_get_releases to get available MOS versions
if ! /usr/local/bin/mos-os_get_releases ; then
  exit 1
fi

# Create necessary directories
mkdir -p /var/mos/mos-update/update >/dev/null 2>&1

# Set version depending on which argument is passed over
if [ "$1" = "latest" ] ; then
  VERSION=$(jq --arg channel "$2" -r '.[] | select(.tag_name | contains($channel)) | .tag_name' /var/mos/mos-update/releases.json | sort -V | tail -1)
  if [ -z "$VERSION" ] ; then
    notify -t "MOS Update" -m "No latest MOS version in Channel $1 found" -p "alert"
    exit 1
  fi
else
  VERSION="$1"
fi

# Display message if upgrading to the same version
if [ "$VERSION" = "$CURRENT_VERSION" ] ; then
  notify -t "MOS Update" -m "Version is the same as the current running MOS version, continung in 10 seconds" -p "warning"
  sleep 10
  notify -t "MOS Update" -m "Redownloading and installing MOS version: $VERSION, you will be notified when it is safe to reboot" -p "normal"
else
  notify -t "MOS Update" -m "Changing MOS version from: $CURRENT_VERSION to version: $VERSION, you will be notified when it is safe to reboot" -p "normal"
fi

# Get assets ID's from rootfs and md5
ASSET_ROOTFS=$(jq --arg version $VERSION -r '.[] | select(.tag_name == $version) | .assets[] | select(.name == "rootfs") | .id' /var/mos/mos-update/releases.json)
ASSET_ROOTFS_MD5=$(jq --arg version $VERSION -r '.[] | select(.tag_name == $version) | .assets[] | select(.name == "rootfs.md5") | .id' /var/mos/mos-update/releases.json)

# Not update Kernel if nothing is passed through
if [ "$3" = "update_kernel" ] ; then
  # Get asset id from mos-release.json
  ASSET_RELEASE_JSON=$(jq --arg version $VERSION -r '.[] | select(.tag_name == $version) | .assets[] | select(.name == "mos-release.json") | .id' /var/mos/mos-update/releases.json)

  # Download mos-release.json and check if download was successful
  curl -s -L \
  "${HEADER[@]}" \
  --header "Accept: application/octet-stream" \
  --header "X-GitHub-Api-Version: 2022-11-28" \
  --output "/var/mos/mos-update/mos-$VERSION.json" \
  "https://api.github.com/repos/ich777/mos-rootfs/releases/assets/$ASSET_RELEASE_JSON"
  EXIT_STATUS=$?
  if [ "$EXIT_STATUS" != "0" ] ; then
    notify -t "MOS Update" -m "Something went wrong getting recommended Kernel version, not updating Kernel" -p "warning"
    rm -f /var/mos/mos-update/mos-$VERSION.json
    UPDATE_KERNEL="false"
  else
    # Extract recommended Kernel version
    KERNEL=$(jq -r '.mos.recommended_kernel' /var/mos/mos-update/mos-$VERSION.json)
    RUNNING_KERNEL=$(uname -r)
    curl -s --request GET \
      --url "https://api.github.com/repos/ich777/mos-kernel/releases?per_page=100" \
      "${HEADER[@]}" \
      --header "X-GitHub-Api-Version: 2022-11-28" \
      --output /var/mos/mos-update/$KERNEL.json
    # Compare if Kernel needs to be upgraded
    if [ "$RUNNING_KERNEL" != $KERNEL ] ; then
      notify -t "MOS Update" -m "Upgrading Kernel to new recommended Kernel: $KERNEL" -p "normal"
      # Get assed ID's for image/drivers and md5's
      ASSET_KERNEL=$(jq --arg kernel $KERNEL -r '.[] | select(.tag_name == $kernel) | .assets[] | select(.name == "image") | .id' /var/mos/mos-update/$KERNEL.json)
      ASSET_DRIVERS=$(jq --arg kernel $KERNEL -r '.[] | select(.tag_name == $kernel) | .assets[] | select(.name == "drivers") | .id' /var/mos/mos-update/$KERNEL.json)
      ASSET_KERNEL_MD5=$(jq --arg kernel $KERNEL -r '.[] | select(.tag_name == $kernel) | .assets[] | select(.name == "image.md5") | .id' /var/mos/mos-update/$KERNEL.json)
      ASSET_DRIVERS_MD5=$(jq --arg kernel $KERNEL -r '.[] | select(.tag_name == $kernel) | .assets[] | select(.name == "drivers.md5") | .id' /var/mos/mos-update/$KERNEL.json)
      UPDATE_KERNEL="true"
    else
      notify -t "MOS Update" -m "No Kernel update needed, continuing with upgrade" -p "normal"
    fi
    # Get assets ID's from microcode and md5
    ASSET_MICROCODE=$(jq --arg kernel $KERNEL -r '.[] | select(.tag_name == $kernel) | .assets[] | select(.name == "microcode") | .id' /var/mos/mos-update/$KERNEL.json)
    ASSET_MICROCODE_MD5=$(jq --arg kernel $KERNEL -r '.[] | select(.tag_name == $kernel) | .assets[] | select(.name == "microcode.md5") | .id' /var/mos/mos-update/$KERNEL.json)
    UPDATE_MICROCODE="true"
  fi
fi

# Download rootfs
echo "Downloading rootfs"
curl --progress-bar -L \
  "${HEADER[@]}" \
  --header "Accept: application/octet-stream" \
  --header "X-GitHub-Api-Version: 2022-11-28" \
  --output "/var/mos/mos-update/update/rootfs" \
  "https://api.github.com/repos/ich777/mos-rootfs/releases/assets/$ASSET_ROOTFS"

# Download rootfs.md5
echo "Downloading rootfs.md5"
curl -s -L \
  "${HEADER[@]}" \
  --header "Accept: application/octet-stream" \
  --header "X-GitHub-Api-Version: 2022-11-28" \
  --output "/var/mos/mos-update/update/rootfs.md5" \
  "https://api.github.com/repos/ich777/mos-rootfs/releases/assets/$ASSET_ROOTFS_MD5"

# Verify checksum
echo "Verifying md5 checksum from rootfs"
if [ "$(md5sum /var/mos/mos-update/update/rootfs | awk '{print $1}')" != "$(cat /var/mos/mos-update/update/rootfs.md5)" ] ; then
  notify -t "MOS Update" -m "rootfs checksum error, aborting MOS update" -p "alert"
  rm -rf /var/mos/mos-update/update
  exit 1
else
  echo "rootfs checksum OK"
fi

if [ "$UPDATE_KERNEL" = "true" ] ; then
  # Download kernel
  echo "Downloading Kernel image"
  curl --progress-bar -L \
    "${HEADER[@]}" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/var/mos/mos-update/update/image" \
    "https://api.github.com/repos/ich777/mos-kernel/releases/assets/$ASSET_KERNEL"

  # Download drivers
  echo "Downloading Kernel drivers"
  curl --progress-bar -L \
    "${HEADER[@]}" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/var/mos/mos-update/update/drivers" \
    "https://api.github.com/repos/ich777/mos-kernel/releases/assets/$ASSET_DRIVERS"

  # Download kernel.md5
  curl -s -L \
    "${HEADER[@]}" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/var/mos/mos-update/update/image.md5" \
    "https://api.github.com/repos/ich777/mos-kernel/releases/assets/$ASSET_KERNEL_MD5"

  # Download drivers.md5
  curl -s -L \
    "${HEADER[@]}" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/var/mos/mos-update/update/drivers.md5" \
    "https://api.github.com/repos/ich777/mos-kernel/releases/assets/$ASSET_DRIVERS_MD5"

  # Verify checksum from image
  echo "Verifying md5 checksum from Kernel image"
  if [ "$(md5sum /var/mos/mos-update/update/image | awk '{print $1}')" != "$(cat /var/mos/mos-update/update/image.md5)" ] ; then
    notify -t "MOS Update" -m "Kernel image checksum error, not updating Kernel" -p "warning"
    rm -f /var/mos/mos-update/update/image* /var/mos/mos-update/update/drivers*
    UPDATE_KERNEL="false"
  else
    echo "Kernel image checksum OK"
    UPDATE_KERNEL="true"
  fi

  # Verify checksum from drivers if image checksum was okay
  if [ "$UPDATE_KERNEL" = "true" ] ; then
    echo "Verifying md5 checksum from Kernel drivers"
    if [ "$(md5sum /var/mos/mos-update/update/drivers | awk '{print $1}')" != "$(cat /var/mos/mos-update/update/drivers.md5)" ] ; then
      notify -t "MOS Update" -m "Kernel drivers checksum error, not updating Kernel" -p "warning"
      rm -f /var/mos/mos-update/update/image* /var/mos/mos-update/update/drivers*
      UPDATE_KERNEL="false"
    else
      echo "Kernel drivers checksum OK"
    fi
  fi
fi

# Download microcode
if [ "$UPDATE_MICROCODE" = "true" ] ; then
# Download microcode
  echo "Downloading microcode"
  curl --progress-bar -L \
    "${HEADER[@]}" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/var/mos/mos-update/update/microcode" \
    "https://api.github.com/repos/ich777/mos-kernel/releases/assets/$ASSET_MICROCODE"
  
  # Download microcode.md5
  echo "Downloading microcode.md5"
  curl -s -L \
    "${HEADER[@]}" \
    --header "Accept: application/octet-stream" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    --output "/var/mos/mos-update/update/microcode.md5" \
    "https://api.github.com/repos/ich777/mos-kernel/releases/assets/$ASSET_MICROCODE_MD5"
  
  # Verify checksum
  echo "Verifying md5 checksum from microcode"
  if [ "$(md5sum /var/mos/mos-update/update/microcode | awk '{print $1}')" != "$(cat /var/mos/mos-update/update/microcode.md5)" ] ; then
    notify -t "MOS Update" -m "microcode checksum error, not updating microcode" -p "alert"
    rm -rf /var/mos/mos-update/update/microcode*
  else
    echo "microcode checksum OK"
  fi
fi

# Get rollback version
ROLLBACK_VERSION=$(jq -r '"\(.mos.version)-\(.mos.channel)"' /boot/rollback/mos-release.json 2>/dev/null)

# Check if rollback version is the same as installed version
if [ "$CURRENT_VERSION" != "$ROLLBACK_VERSION" ] ; then
  echo "Moving current MOS version to /boot/rollback"
  if [ ! -d /boot/rollback ] ; then
    mkdir -p /boot/rollback >/dev/null 2>&1
  else
    rm -rf /boot/rollback/*
  fi
  mv /boot/rootfs* /boot/rollback/
  cp /etc/mos-release.json /boot/rollback/


  if [ "$UPDATE_KERNEL" = "true" ] ; then
    echo "Moving Kernel image and drivers to /boot/rollback"
    mv /boot/image* /boot/drivers* /boot/rollback/
  fi
  if [ "$UPDATE_MICROCODE" = "true" ] ; then
    echo "Moving microcode to /boot/rollback"
    mv /boot/microcode* /boot/rollback/
  fi
else
  echo "Rollback MOS version already in palce"
fi

echo "Moving files into place, please wait"
mv /var/mos/mos-update/update/rootfs* /boot/
if [ "$UPDATE_KERNEL" = "true" ] ; then
  mv /var/mos/mos-update/update/image* /var/mos/mos-update/update/drivers* /boot/

  # Driver plugin update routine
  for plugin in /boot/optional/plugins/*; do
    VERSION_PATH=$(ls -d $plugin/*/ 2>/dev/null | sort -V | tail -1)
    if [ -f "$VERSION_PATH/functions" ] ; then
      (
        source $VERSION_PATH/functions
        if type mos-osupdate &>/dev/null ; then
          mos-osupdate "$KERNEL"
        fi
      )
    fi
  done
fi
if [ "$UPDATE_MICROCODE" = "true" ] ; then
  mv /var/mos/mos-update/update/microcode* /boot/
fi

notify -t "MOS Update" -m "MOS update done, please reboot" -p "normal"

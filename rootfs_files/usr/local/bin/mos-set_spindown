#!/bin/sh
# Exit if no argument is passed over
if [ -z "$1" ] ; then
  exit 1
fi

# Set device variable
DEVICE="$1"

# Try to get UUID and spindown from individual disk
DEVICE_UUID=$(lsblk -no UUID $DEVICE | xargs)
if [ ! -z "$DEVICE_UUID" ] ; then
  SPINDOWN=$(/usr/bin/jq -r --arg uuid "$DEVICE_UUID" '.[].data_devices.[] | select(.id == $uuid) | .spindown // empty' /boot/config/pools.json 2>/dev/null)
fi
# If Spindown is empty fall back to global spindown
if [ -z "$SPINDOWN" ] ; then
  SPINDOWN=$(/usr/bin/jq -r '.global_spindown' /boot/config/system.json 2>/dev/null)
fi

# Get HDD model
MODEL=$(/sbin/hdparm -I $DEVICE 2>/dev/null | /bin/grep "Model Number:" | /usr/bin/cut -d ':' -f2 | tr -d ' ')

# Spindown math function
if [ "$SPINDOWN" -le 0 ]; then
  SPINDOWN_VALUE=0
elif [ "$SPINDOWN" -le 20 ]; then
  SPINDOWN_VALUE=$((SPINDOWN * 12))
elif [ $((SPINDOWN % 30)) -eq 0 ] && [ $((SPINDOWN / 30 + 240)) -le 251 ]; then
  SPINDOWN_VALUE=$((240 + SPINDOWN / 30))
else
  SPINDOWN_VALUE=241
fi

# Workaround for WD disks
case "$MODEL" in
  WD*|WDC*)
    /sbin/hdparm -s 0 $DEVICE >/dev/null 2>&1
    /sbin/hdparm -B 128 $DEVICE >/dev/null 2>&1
    ;;
esac

# Set spindown
/sbin/hdparm -S $SPINDOWN_VALUE $DEVICE >/dev/null 2>&1

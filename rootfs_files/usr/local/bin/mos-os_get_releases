#!/bin/sh

# Import MOS functions
. /usr/local/lib/functions/mos-common

# Create directory
mkdir -p /var/mos/mos-update >/dev/null 2>&1

# Get last 50 releases:
get_releases() {
  echo "Trying to get MOS releases"

  GH_TOKEN=$(jq -r '.github // empty' /boot/config/system/tokens.json)
  if [ ! -z "$GH_TOKEN" ] ; then
    TOKEN="$(decrypt_password "$GH_TOKEN" "tokens")"
    HEADER=(--header "Authorization: Bearer $TOKEN")
  else
    HEADER=()
  fi

  curl -s --request GET \
    --url 'https://api.github.com/repos/ich777/mos-rootfs/releases?per_page=50' \
    "${HEADER[@]}" \
    --header 'X-GitHub-Api-Version: 2022-11-28' \
    -o /var/mos/mos-update/releases.json
  EXIT_STATUS=$?
  if [ "$EXIT_STATUS" != "0" ] ; then
    echo "Something went wrong gathering MOS releases"
    exit 1
  else
    echo "Download from MOS releases successful!"
  fi
}

# Check file modification time, if file is older than 5 minutes or
# doesn't exist get file agian
if [ ! -f /var/mos/mos-update/releases.json ] ; then
  get_releases
else
  CURENTTIME=$(date +%s)
  FILETIME=$(stat /var/mos/mos-update/releases.json -c %Y)
  DIFF=$(expr $CURENTTIME - $FILETIME)
  CHK_TIMEOUT=300
  if [ $DIFF -gt $CHK_TIMEOUT ] ; then
    rm -f /var/mos/mos-update/releases.json
    get_releases
  else
    echo "releases.json up to date, try again in a few minutes"
  fi
fi

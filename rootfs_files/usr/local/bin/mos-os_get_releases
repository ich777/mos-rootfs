#!/bin/sh

mkdir -p /tmp/mos-update >/dev/null 2>&1

# Get last 50 releases:
get_releases() {
  echo "Trying to get MOS releases"
  curl -s --request GET \
    --url "https://api.github.com/repos/ich777/mos-releases/releases?per_page=50" \
    --header "Authorization: Bearer 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" \
    --header "X-GitHub-Api-Version: 2022-11-28" \
    -o /tmp/mos-update/releases.json
  EXIT_STATUS=$?
  if [ "$EXIT_STATUS" != "0" ] ; then
    echo "Something went wrong gathering MOS releases"
    exit 1
  else
    echo "Download from MOS releases successful!"
  fi
}

if [ ! -f /tmp/mos-update/releases.json ] ; then
  get_releases
else
  CURENTTIME=$(date +%s)
  FILETIME=$(stat /tmp/mos-update/releases.json -c %Y)
  DIFF=$(expr $CURENTTIME - $FILETIME)
  CHK_TIMEOUT=300
  if [ $DIFF -gt $CHK_TIMEOUT ] ; then
    rm -f /tmp/mos-update/releases.json
    get_releases
  else
    echo "releases.json up to date, try again in a few minutes"
  fi
fi

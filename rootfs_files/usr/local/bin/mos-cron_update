#!/bin/bash
crontab=""

# Set variables
crontab="# Set Environment for cronjobs"'\n'"SHELL=/bin/bash"'\n'"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"'\n'"TERM=xterm"'\n'

# Read pools.json
POOLS_JSON=$(jq -r '.' /boot/config/pools.json 2>/dev/null)
POOLS_MERGERFS=$(echo $POOLS_JSON | jq -r '.[] | select(.type == "mergerfs") | .id')

# Normalize schedules to be fully cron compliant
convert_schedule() {
  echo "$1" | sed -e 's/\b[Ss][Uu][Nn]\b/0/g' \
    -e 's/\b[Mm][Oo][Nn]\b/1/g' \
    -e 's/\b[Tt][Uu][Ee]\b/2/g' \
    -e 's/\b[Ww][Ee][Dd]\b/3/g' \
    -e 's/\b[Tt][Hh][Uu]\b/4/g' \
    -e 's/\b[Ff][Rr][Ii]\b/5/g' \
    -e 's/\b[Ss][Aa][Tt]\b/6/g'
}

# Scan for mergerfs Schedules and add them to cron list
pools_cron=""
if [ "$POOLS_MERGERFS" != "" ] && [ "$POOLS_MERGERFS" != "null" ]; then
  IFS=$'\n'
  for pool in $POOLS_MERGERFS; do
    SYNC_ENABLED=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .config.sync.enabled")
    if [ "$SYNC_ENABLED" != "" ] && [ "$SYNC_ENABLED" != "null" ] && [ "$SYNC_ENABLED" == "true" ]; then
      POOL_NAME=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .name")
      SYNC_SCHEDULE=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .config.sync.schedule")
      SYNC_SCHEDULE=$(convert_schedule "$SYNC_SCHEDULE")
      pools_cron="# MOS $POOL_NAME Parity Sync:"'\n'"$SYNC_SCHEDULE /usr/local/bin/mos-snapraid $POOL_NAME sync > /dev/null 2>&1"'\n'
      SCRUB_ENABLED=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .config.sync.scrub.enabled")
      if [ "$SCRUB_ENABLED" != "" ] && [ "$SCRUB_ENABLED" != "null" ] && [ "$SCRUB_ENABLED" == "true" ]; then
        SCRUB_SCHEDULE=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .config.sync.scrub.schedule")
        pools_cron="$pools_cron# MOS $POOL_NAME Parity Scrub:"'\n'"$SCRUB_SCHEDULE /usr/local/bin/mos-snapraid $POOL_NAME scrub > /dev/null 2>&1"'\n'
      fi
      CHECK_ENABLED=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .config.sync.check.enabled")
      if [ "$CHECK_ENABLED" != "" ] && [ "$CHECK_ENABLED" != "null" ] && [ "$CHECK_ENABLED" == "true" ]; then
        CHECK_SCHEDULE=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$pool\") | .config.sync.check.schedule")
        pools_cron="$pools_cron# MOS $POOL_NAME Parity Check:"'\n'"$CHECK_SCHEDULE /usr/local/bin/mos-snapraid $POOL_NAME check > /dev/null 2>&1"'\n'
      fi
    fi
  done
fi
crontab="$crontab$pools_cron"

# Scan for nonraid Schedules and add them to cron list
ID_NONRAID=$(echo $POOLS_JSON | jq -r '.[] | select(.type == "nonraid") | .id')
nonraid_cron=""
if [ "$ID_NONRAID" != "" ] && [ "$ID_NONRAID" != "null" ]; then
  CHECK_ENABLED=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$ID_NONRAID\") | .config.check.enabled")
  if [ "$CHECK_ENABLED" != "" ] && [ "$CHECK_ENABLED" != "null" ] && [ "$CHECK_ENABLED" == "true" ]; then
    POOL_NAME=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$ID_NONRAID\") | .name")
    CHECK_SCHEDULE=$(echo "$POOLS_JSON" | jq -r ".[] | select(.id == \"$ID_NONRAID\") | .config.check.schedule")
    nonraid_cron="# MOS $POOL_NAME Parity Check:"'\n'"$CHECK_SCHEDULE echo \"check\" > /proc/nmdcmd 2>/dev/null"'\n'
  fi
fi
crontab="$crontab$nonraid_cron"

# Read docker.json
DOCKER_JSON=$(jq -r '.' /boot/config/docker.json 2>/dev/null)
DOCKER_UPDATE=$(echo $DOCKER_JSON | jq -r '.update_check.enabled')

# Scan for docker Schedules and add them to cron list
docker_cron=""
if [ "$DOCKER_UPDATE" != "" ] && [ "$DOCKER_UPDATE" != "null" ] && [ "$DOCKER_UPDATE" == "true" ]; then
  DOCKER_UPDATE_SCHEDULE=$(echo "$DOCKER_JSON" | jq -r '.update_check.update_check_schedule')
  docker_cron="# MOS Docker Update Check:"'\n'"$DOCKER_UPDATE_SCHEDULE /usr/local/bin/mos-check_for_docker_updates \"\" \"notification\" > /dev/null 2>&1"'\n'
  DOCKER_AUTO_UPDATE=$(echo "$DOCKER_JSON" | jq -r '.update_check.auto_update.enabled')
  if [ "$DOCKER_AUTO_UPDATE" != "null" ] && [ "$DOCKER_AUTO_UPDATE" != "" ] && [ "$DOCKER_AUTO_UPDATE" == "true" ]; then
    DOCKER_AUTO_UPDATE=$(echo "$DOCKER_JSON" | jq -r '.update_check.auto_update.auto_update_schedule')
    DOCKER_AUTO_UPDATE=$(convert_schedule "$DOCKER_AUTO_UPDATE")
    docker_cron="# MOS Docker Auto Update:"'\n'"$DOCKER_AUTO_UPDATE /usr/local/bin/mos-update_containers \"\" \"notification\" > /dev/null 2>&1"'\n'"$docker_cron"
  fi
fi
crontab="$crontab$docker_cron"

# Read hub.json
HUB_JSON=$(jq -r '.' /boot/config/system/hub.json 2>/dev/null)
HUB_ENABLED=$(echo $HUB_JSON | jq -r '.enabled')

# Scan for docker Schedules and add them to cron list
hub_cron=""
if [ "$HUB_ENABLED" != "" ] && [ "$HUB_ENABLED" != "null" ] && [ "$HUB_ENABLED" == "true" ]; then
  HUB_UPDATE_SCHEDULE=$(echo "$HUB_JSON" | jq -r '.schedule')
  if [ "$HUB_UPDATE_SCHEDULE" != "" ] && [ "$HUB_UPDATE_SCHEDULE" != "null" ] ; then
    hub_cron="# MOS HUB Update Interval:"'\n'"$HUB_UPDATE_SCHEDULE node /usr/local/bin/mos-api_cli hub:update > /dev/null 2>&1"'\n'
  fi
fi
crontab="$crontab$hub_cron"

# Get all crontab entries
cron_jobs=""
CRON_JSON=$(jq -r '.' /boot/config/system/cron.json 2>/dev/null)
CRONJOBS=$(echo $CRON_JSON | jq -r '.[] | select(.enabled == true) | .id')
if [ "$CRONJOBS" != "" ] && [ "$CRONJOBS" != "null" ] && [ "$CRONJOBS" != "[]" ] ; then
  IFS=$'\n'
  for cronjob in $CRONJOBS; do
    NAME=$(echo $CRON_JSON | jq -r ".[] | select(.id == \"$cronjob\") | .name")
    SCHEDULE=$(echo "$CRON_JSON" | jq -r ".[] | select(.id == \"$cronjob\") | .schedule")
    SCHEDULE=$(convert_schedule "$SCHEDULE")
    COMMAND=$(echo "$CRON_JSON" | jq -r ".[] | select(.id == \"$cronjob\") | .command")
    if [ "$NAME" != "null" ] && [ "$SCHEDULE" != "null" ] && [ "$COMMAND" != "null" ]; then
      cron_jobs="$cron_jobs# $NAME:"'\n'"$SCHEDULE $COMMAND"'\n'
    fi
  done
fi
crontab="$crontab$cron_jobs"

# Inject cron list into crontab
echo -e $crontab | awk 'NF' | crontab -
